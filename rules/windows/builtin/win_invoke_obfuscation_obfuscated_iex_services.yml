filter: 'winlog.event_id: 7045 AND (winlog.event_data.ImagePath|re: "\$PSHome\[\s*\d{1,3}\s*\]\s*\+\s*\$PSHome\["
  OR winlog.event_data.ImagePath|re: "\$ShellId\[\s*\d{1,3}\s*\]\s*\+\s*\$ShellId\["
  OR winlog.event_data.ImagePath|re: "\$env:Public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:Public\["
  OR winlog.event_data.ImagePath|re: "\$env:ComSpec\[(\s*\d{1,3}\s*,){2}" OR winlog.event_data.ImagePath|re:
  "\*mdr\*\W\s*\)\.Name" OR winlog.event_data.ImagePath|re: "\$VerbosePreference\.ToString\("
  OR winlog.event_data.ImagePath|re: "\String\]\s*\$VerbosePreference")'
pre_detector:
  case_condition: directly
  id: 51aa9387-1c53-4153-91cc-d73c59ae1ca9
  mitre:
  - attack.defense_evasion
  - attack.t1027
  severity: high
  title: Invoke-Obfuscation Obfuscated IEX Invocation
sigma_fields: true
description: "Detects all variations of obfuscated powershell IEX invocation code\
  \ generated by Invoke-Obfuscation framework from the following code block \u2014\
  \ https://github.com/danielbohannon/Invoke-Obfuscation/blob/master/Out-ObfuscatedStringCommand.ps1#L873-L888"
---
filter: 'winlog.channel: "Microsoft-Windows-Sysmon/Operational" AND winlog.event_id:
  6 AND (winlog.event_data.ImagePath|re: "\$PSHome\[\s*\d{1,3}\s*\]\s*\+\s*\$PSHome\["
  OR winlog.event_data.ImagePath|re: "\$ShellId\[\s*\d{1,3}\s*\]\s*\+\s*\$ShellId\["
  OR winlog.event_data.ImagePath|re: "\$env:Public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:Public\["
  OR winlog.event_data.ImagePath|re: "\$env:ComSpec\[(\s*\d{1,3}\s*,){2}" OR winlog.event_data.ImagePath|re:
  "\*mdr\*\W\s*\)\.Name" OR winlog.event_data.ImagePath|re: "\$VerbosePreference\.ToString\("
  OR winlog.event_data.ImagePath|re: "\String\]\s*\$VerbosePreference")'
pre_detector:
  case_condition: directly
  id: 51aa9387-1c53-4153-91cc-d73c59ae1ca9
  mitre:
  - attack.defense_evasion
  - attack.t1027
  severity: high
  title: Invoke-Obfuscation Obfuscated IEX Invocation
sigma_fields: true
description: "Detects all variations of obfuscated powershell IEX invocation code\
  \ generated by Invoke-Obfuscation framework from the following code block \u2014\
  \ https://github.com/danielbohannon/Invoke-Obfuscation/blob/master/Out-ObfuscatedStringCommand.ps1#L873-L888"
---
filter: 'winlog.channel: "Security" AND winlog.event_id: 4697 AND (winlog.event_data.ImagePath|re:
  "\$PSHome\[\s*\d{1,3}\s*\]\s*\+\s*\$PSHome\[" OR winlog.event_data.ImagePath|re:
  "\$ShellId\[\s*\d{1,3}\s*\]\s*\+\s*\$ShellId\[" OR winlog.event_data.ImagePath|re:
  "\$env:Public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:Public\[" OR winlog.event_data.ImagePath|re:
  "\$env:ComSpec\[(\s*\d{1,3}\s*,){2}" OR winlog.event_data.ImagePath|re: "\*mdr\*\W\s*\)\.Name"
  OR winlog.event_data.ImagePath|re: "\$VerbosePreference\.ToString\(" OR winlog.event_data.ImagePath|re:
  "\String\]\s*\$VerbosePreference")'
pre_detector:
  case_condition: directly
  id: 51aa9387-1c53-4153-91cc-d73c59ae1ca9
  mitre:
  - attack.defense_evasion
  - attack.t1027
  severity: high
  title: Invoke-Obfuscation Obfuscated IEX Invocation
sigma_fields: true
description: "Detects all variations of obfuscated powershell IEX invocation code\
  \ generated by Invoke-Obfuscation framework from the following code block \u2014\
  \ https://github.com/danielbohannon/Invoke-Obfuscation/blob/master/Out-ObfuscatedStringCommand.ps1#L873-L888"