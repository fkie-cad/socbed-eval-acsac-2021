filter: '(winlog.event_id: 4104 AND (ScriptBlockText|re: "\$PSHome\[\s*\d{1,3}\s*\]\s*\+\s*\$PSHome\["
  OR ScriptBlockText|re: "\$ShellId\[\s*\d{1,3}\s*\]\s*\+\s*\$ShellId\[" OR ScriptBlockText|re:
  "\$env:Public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:Public\[" OR ScriptBlockText|re: "\$env:ComSpec\[(\s*\d{1,3}\s*,){2}"
  OR ScriptBlockText|re: "\*mdr\*\W\s*\)\.Name" OR ScriptBlockText|re: "\$VerbosePreference\.ToString\("
  OR ScriptBlockText|re: "\String\]\s*\$VerbosePreference")) OR (winlog.event_id:
  4103 AND (Payload|re: "\$PSHome\[\s*\d{1,3}\s*\]\s*\+\s*\$PSHome\[" OR Payload|re:
  "\$ShellId\[\s*\d{1,3}\s*\]\s*\+\s*\$ShellId\[" OR Payload|re: "\$env:Public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:Public\["
  OR Payload|re: "\$env:ComSpec\[(\s*\d{1,3}\s*,){2}" OR Payload|re: "\*mdr\*\W\s*\)\.Name"
  OR Payload|re: "\$VerbosePreference\.ToString\(" OR Payload|re: "\String\]\s*\$VerbosePreference"))'
pre_detector:
  case_condition: directly
  id: 1b9dc62e-6e9e-42a3-8990-94d7a10007f7
  mitre:
  - attack.defense_evasion
  - attack.t1027
  - attack.execution
  - attack.t1059.001
  - attack.t1086
  severity: high
  title: Invoke-Obfuscation Obfuscated IEX Invocation
sigma_fields: true
description: "Detects all variations of obfuscated powershell IEX invocation code\
  \ generated by Invoke-Obfuscation framework from the following code block \u2014\
  \ https://github.com/danielbohannon/Invoke-Obfuscation/blob/master/Out-ObfuscatedStringCommand.ps1#L873-L888"